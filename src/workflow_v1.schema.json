{
  "$id": "https://modelrelay.ai/schemas/workflow_v1.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "additionalProperties": false,
  "definitions": {
    "condition": {
      "additionalProperties": false,
      "properties": {
        "op": {
          "enum": [
            "equals",
            "matches",
            "exists"
          ],
          "type": "string"
        },
        "path": {
          "pattern": "^\\$.*$",
          "type": "string"
        },
        "source": {
          "enum": [
            "node_output",
            "node_status"
          ],
          "type": "string"
        },
        "value": {
          "oneOf": [
            {
              "type": "string"
            },
            {
              "type": "number"
            },
            {
              "type": "integer"
            },
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ]
        }
      },
      "required": [
        "source",
        "op"
      ],
      "type": "object"
    },
    "edge": {
      "additionalProperties": false,
      "properties": {
        "from": {
          "minLength": 1,
          "type": "string"
        },
        "to": {
          "minLength": 1,
          "type": "string"
        },
        "when": {
          "$ref": "#/definitions/condition"
        }
      },
      "required": [
        "from",
        "to"
      ],
      "type": "object"
    },
    "fragmentBindInput": {
      "additionalProperties": false,
      "oneOf": [
        {
          "required": [
            "from_node"
          ]
        },
        {
          "required": [
            "from_input"
          ]
        }
      ],
      "properties": {
        "from_input": {
          "minLength": 1,
          "type": "string"
        },
        "from_node": {
          "minLength": 1,
          "type": "string"
        },
        "pointer": {
          "pattern": "^(/.*)?$",
          "type": "string"
        }
      },
      "type": "object"
    },
    "fragmentDef": {
      "additionalProperties": false,
      "properties": {
        "edges": {
          "items": {
            "$ref": "#/definitions/edge"
          },
          "type": "array"
        },
        "inputs": {
          "items": {
            "$ref": "#/definitions/fragmentInput"
          },
          "type": "array"
        },
        "nodes": {
          "items": {
            "$ref": "#/definitions/node"
          },
          "minItems": 1,
          "type": "array"
        },
        "outputs": {
          "items": {
            "$ref": "#/definitions/fragmentOutput"
          },
          "minItems": 1,
          "type": "array"
        }
      },
      "required": [
        "outputs",
        "nodes"
      ],
      "type": "object"
    },
    "fragmentInput": {
      "additionalProperties": false,
      "properties": {
        "name": {
          "minLength": 1,
          "type": "string"
        },
        "type": {
          "enum": [
            "json",
            "string",
            "array",
            "object",
            "number",
            "boolean",
            "null"
          ],
          "type": "string"
        }
      },
      "required": [
        "name"
      ],
      "type": "object"
    },
    "fragmentOutput": {
      "additionalProperties": false,
      "properties": {
        "from_node": {
          "minLength": 1,
          "type": "string"
        },
        "name": {
          "minLength": 1,
          "type": "string"
        },
        "pointer": {
          "pattern": "^(/.*)?$",
          "type": "string"
        }
      },
      "required": [
        "name",
        "from_node"
      ],
      "type": "object"
    },
    "llmResponsesBinding": {
      "additionalProperties": false,
      "oneOf": [
        {
          "required": [
            "to"
          ]
        },
        {
          "required": [
            "to_placeholder"
          ]
        }
      ],
      "properties": {
        "encoding": {
          "enum": [
            "json",
            "json_string"
          ],
          "type": "string"
        },
        "from": {
          "minLength": 1,
          "type": "string"
        },
        "pointer": {
          "pattern": "^(/.*)?$",
          "type": "string"
        },
        "to": {
          "pattern": "^/.*$",
          "type": "string"
        },
        "to_placeholder": {
          "minLength": 1,
          "type": "string"
        }
      },
      "required": [
        "from"
      ],
      "type": "object"
    },
    "mapFanoutItemBinding": {
      "additionalProperties": false,
      "oneOf": [
        {
          "required": [
            "to"
          ]
        },
        {
          "required": [
            "to_placeholder"
          ]
        }
      ],
      "properties": {
        "encoding": {
          "enum": [
            "json",
            "json_string"
          ],
          "type": "string"
        },
        "path": {
          "pattern": "^(/.*)?$",
          "type": "string"
        },
        "to": {
          "pattern": "^/.*$",
          "type": "string"
        },
        "to_placeholder": {
          "minLength": 1,
          "type": "string"
        }
      },
      "type": "object"
    },
    "node": {
      "additionalProperties": false,
      "oneOf": [
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "properties": {
                    "bindings": {
                      "items": {
                        "$ref": "#/definitions/llmResponsesBinding"
                      },
                      "type": "array"
                    },
                    "max_tool_steps": {
                      "default": 10,
                      "maximum": 64,
                      "minimum": 1,
                      "type": "integer"
                    },
                    "request": {
                      "type": "object"
                    },
                    "stream": {
                      "type": "boolean"
                    },
                    "tool_execution": {
                      "additionalProperties": false,
                      "properties": {
                        "mode": {
                          "default": "server",
                          "enum": [
                            "server",
                            "client",
                            "agentic"
                          ],
                          "type": "string"
                        }
                      },
                      "required": [
                        "mode"
                      ],
                      "type": "object"
                    },
                    "tool_limits": {
                      "additionalProperties": false,
                      "properties": {
                        "max_llm_calls": {
                          "default": 8,
                          "maximum": 64,
                          "minimum": 1,
                          "type": "integer"
                        },
                        "max_tool_calls_per_step": {
                          "default": 16,
                          "maximum": 64,
                          "minimum": 1,
                          "type": "integer"
                        },
                        "wait_ttl_ms": {
                          "default": 900000,
                          "maximum": 86400000,
                          "minimum": 1,
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "required": [
                    "request"
                  ],
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "llm.responses"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "properties": {
                    "agent": {
                      "minLength": 1,
                      "type": "string"
                    },
                    "bindings": {
                      "items": {
                        "$ref": "#/definitions/llmResponsesBinding"
                      },
                      "type": "array"
                    },
                    "input": {
                      "type": "array"
                    },
                    "override": {
                      "additionalProperties": false,
                      "properties": {
                        "max_duration_sec": {
                          "minimum": 0,
                          "type": "integer"
                        },
                        "max_steps": {
                          "minimum": 1,
                          "type": "integer"
                        },
                        "model": {
                          "type": "string"
                        },
                        "step_timeout_sec": {
                          "minimum": 0,
                          "type": "integer"
                        },
                        "system": {
                          "type": "string"
                        },
                        "tool_failure_policy": {
                          "enum": [
                            "stop",
                            "continue",
                            "retry"
                          ],
                          "type": "string"
                        },
                        "tool_retry_count": {
                          "minimum": 0,
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "required": [
                    "agent",
                    "input"
                  ],
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "agent.run"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "properties": {
                    "bindings": {
                      "items": {
                        "$ref": "#/definitions/llmResponsesBinding"
                      },
                      "type": "array"
                    },
                    "max_tool_steps": {
                      "default": 10,
                      "maximum": 64,
                      "minimum": 1,
                      "type": "integer"
                    },
                    "request": {
                      "type": "object"
                    },
                    "stream": {
                      "type": "boolean"
                    },
                    "tool_execution": {
                      "additionalProperties": false,
                      "properties": {
                        "mode": {
                          "default": "server",
                          "enum": [
                            "server",
                            "client",
                            "agentic"
                          ],
                          "type": "string"
                        }
                      },
                      "required": [
                        "mode"
                      ],
                      "type": "object"
                    },
                    "tool_limits": {
                      "additionalProperties": false,
                      "properties": {
                        "max_llm_calls": {
                          "default": 8,
                          "maximum": 64,
                          "minimum": 1,
                          "type": "integer"
                        },
                        "max_tool_calls_per_step": {
                          "default": 16,
                          "maximum": 64,
                          "minimum": 1,
                          "type": "integer"
                        },
                        "wait_ttl_ms": {
                          "default": 900000,
                          "maximum": 86400000,
                          "minimum": 1,
                          "type": "integer"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "required": [
                    "request"
                  ],
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "route.switch"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "properties": {
            "type": {
              "const": "join.all"
            }
          }
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "additionalProperties": false,
                  "properties": {
                    "predicate": {
                      "$ref": "#/definitions/condition"
                    }
                  },
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "join.any"
            }
          }
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "additionalProperties": false,
                  "properties": {
                    "limit": {
                      "minimum": 1,
                      "type": "integer"
                    },
                    "predicate": {
                      "$ref": "#/definitions/condition"
                    },
                    "timeout_ms": {
                      "minimum": 1,
                      "type": "integer"
                    }
                  },
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "join.collect"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "additionalProperties": false,
                  "oneOf": [
                    {
                      "not": {
                        "required": [
                          "merge"
                        ]
                      },
                      "required": [
                        "object"
                      ]
                    },
                    {
                      "not": {
                        "required": [
                          "object"
                        ]
                      },
                      "required": [
                        "merge"
                      ]
                    }
                  ],
                  "properties": {
                    "merge": {
                      "items": {
                        "$ref": "#/definitions/transformValue"
                      },
                      "minItems": 1,
                      "type": "array"
                    },
                    "object": {
                      "additionalProperties": {
                        "$ref": "#/definitions/transformValue"
                      },
                      "minProperties": 1,
                      "type": "object"
                    }
                  },
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "transform.json"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "additionalProperties": false,
                  "properties": {
                    "item_bindings": {
                      "items": {
                        "$ref": "#/definitions/mapFanoutItemBinding"
                      },
                      "type": "array"
                    },
                    "items": {
                      "additionalProperties": false,
                      "properties": {
                        "from": {
                          "minLength": 1,
                          "type": "string"
                        },
                        "path": {
                          "pattern": "^(/.*)?$",
                          "type": "string"
                        },
                        "pointer": {
                          "pattern": "^(/.*)?$",
                          "type": "string"
                        }
                      },
                      "required": [
                        "from"
                      ],
                      "type": "object"
                    },
                    "max_parallelism": {
                      "minimum": 1,
                      "type": "integer"
                    },
                    "subnode": {
                      "additionalProperties": false,
                      "properties": {
                        "id": {
                          "minLength": 1,
                          "type": "string"
                        },
                        "input": {},
                        "type": {
                          "enum": [
                            "llm.responses",
                            "route.switch",
                            "transform.json"
                          ],
                          "type": "string"
                        }
                      },
                      "required": [
                        "id",
                        "type"
                      ],
                      "type": "object"
                    }
                  },
                  "required": [
                    "items",
                    "subnode"
                  ],
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "map.fanout"
            }
          },
          "required": [
            "input"
          ]
        },
        {
          "allOf": [
            {
              "properties": {
                "input": {
                  "additionalProperties": false,
                  "properties": {
                    "bind_inputs": {
                      "additionalProperties": {
                        "$ref": "#/definitions/fragmentBindInput"
                      },
                      "type": "object"
                    },
                    "ref": {
                      "minLength": 1,
                      "type": "string"
                    }
                  },
                  "required": [
                    "ref"
                  ],
                  "type": "object"
                }
              }
            }
          ],
          "properties": {
            "type": {
              "const": "fragment"
            }
          },
          "required": [
            "input"
          ]
        }
      ],
      "properties": {
        "id": {
          "minLength": 1,
          "type": "string"
        },
        "input": {},
        "type": {
          "enum": [
            "llm.responses",
            "agent.run",
            "route.switch",
            "join.all",
            "join.any",
            "join.collect",
            "transform.json",
            "map.fanout",
            "fragment"
          ],
          "type": "string"
        }
      },
      "required": [
        "id",
        "type"
      ],
      "type": "object"
    },
    "output": {
      "additionalProperties": false,
      "properties": {
        "from": {
          "minLength": 1,
          "type": "string"
        },
        "name": {
          "minLength": 1,
          "type": "string"
        },
        "output": {
          "minLength": 1,
          "type": "string"
        },
        "pointer": {
          "pattern": "^(/.*)?$",
          "type": "string"
        }
      },
      "required": [
        "name",
        "from"
      ],
      "type": "object"
    },
    "transformValue": {
      "additionalProperties": false,
      "properties": {
        "from": {
          "minLength": 1,
          "type": "string"
        },
        "pointer": {
          "pattern": "^(/.*)?$",
          "type": "string"
        }
      },
      "required": [
        "from"
      ],
      "type": "object"
    }
  },
  "properties": {
    "edges": {
      "items": {
        "$ref": "#/definitions/edge"
      },
      "type": "array"
    },
    "execution": {
      "additionalProperties": false,
      "properties": {
        "max_parallelism": {
          "minimum": 1,
          "type": "integer"
        },
        "node_timeout_ms": {
          "minimum": 1,
          "type": "integer"
        },
        "run_timeout_ms": {
          "minimum": 1,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "fragments": {
      "additionalProperties": {
        "$ref": "#/definitions/fragmentDef"
      },
      "type": "object"
    },
    "kind": {
      "const": "workflow.v1",
      "type": "string"
    },
    "name": {
      "type": "string"
    },
    "nodes": {
      "items": {
        "$ref": "#/definitions/node"
      },
      "minItems": 1,
      "type": "array"
    },
    "outputs": {
      "items": {
        "$ref": "#/definitions/output"
      },
      "minItems": 1,
      "type": "array"
    }
  },
  "required": [
    "kind",
    "nodes",
    "outputs"
  ],
  "title": "ModelRelay workflow.v1",
  "type": "object"
}
