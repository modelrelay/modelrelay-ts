{
  "$id": "https://modelrelay.ai/schemas/run_event_v0.schema.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "additionalProperties": false,
  "definitions": {
    "functionToolCall": {
      "additionalProperties": false,
      "properties": {
        "arguments": {
          "type": "string"
        },
        "id": {
          "minLength": 1,
          "type": "string"
        },
        "name": {
          "minLength": 1,
          "type": "string"
        }
      },
      "required": [
        "id",
        "name",
        "arguments"
      ],
      "type": "object"
    },
    "nodeError": {
      "additionalProperties": false,
      "properties": {
        "code": {
          "type": "string"
        },
        "message": {
          "minLength": 1,
          "type": "string"
        }
      },
      "required": [
        "message"
      ],
      "type": "object"
    },
    "nodeLLMCall": {
      "additionalProperties": false,
      "properties": {
        "model": {
          "type": "string"
        },
        "provider": {
          "type": "string"
        },
        "request_id": {
          "format": "uuid",
          "type": "string"
        },
        "response_id": {
          "type": "string"
        },
        "step": {
          "minimum": 0,
          "type": "integer"
        },
        "stop_reason": {
          "type": "string"
        },
        "usage": {
          "$ref": "#/definitions/tokenUsage"
        }
      },
      "required": [
        "step",
        "request_id"
      ],
      "type": "object"
    },
    "nodeOutputDelta": {
      "additionalProperties": false,
      "properties": {
        "kind": {
          "minLength": 1,
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "response_id": {
          "type": "string"
        },
        "text_delta": {
          "type": "string"
        }
      },
      "required": [
        "kind"
      ],
      "type": "object"
    },
    "nodeToolCall": {
      "additionalProperties": false,
      "properties": {
        "request_id": {
          "format": "uuid",
          "type": "string"
        },
        "step": {
          "minimum": 0,
          "type": "integer"
        },
        "tool_call": {
          "$ref": "#/definitions/functionToolCall"
        }
      },
      "required": [
        "step",
        "request_id",
        "tool_call"
      ],
      "type": "object"
    },
    "nodeToolResult": {
      "additionalProperties": false,
      "properties": {
        "name": {
          "minLength": 1,
          "type": "string"
        },
        "output": {
          "type": "string"
        },
        "request_id": {
          "format": "uuid",
          "type": "string"
        },
        "step": {
          "minimum": 0,
          "type": "integer"
        },
        "tool_call_id": {
          "minLength": 1,
          "type": "string"
        }
      },
      "required": [
        "step",
        "request_id",
        "tool_call_id",
        "name",
        "output"
      ],
      "type": "object"
    },
    "nodeWaiting": {
      "additionalProperties": false,
      "properties": {
        "pending_tool_calls": {
          "items": {
            "$ref": "#/definitions/pendingToolCall"
          },
          "minItems": 1,
          "type": "array"
        },
        "reason": {
          "minLength": 1,
          "type": "string"
        },
        "request_id": {
          "format": "uuid",
          "type": "string"
        },
        "step": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "required": [
        "step",
        "request_id",
        "pending_tool_calls",
        "reason"
      ],
      "type": "object"
    },
    "payloadInfo": {
      "additionalProperties": false,
      "properties": {
        "bytes": {
          "minimum": 0,
          "type": "integer"
        },
        "included": {
          "type": "boolean"
        },
        "sha256": {
          "pattern": "^[0-9a-f]{64}$",
          "type": "string"
        }
      },
      "required": [
        "bytes",
        "sha256",
        "included"
      ],
      "type": "object"
    },
    "pendingToolCall": {
      "additionalProperties": false,
      "properties": {
        "arguments": {
          "type": "string"
        },
        "name": {
          "minLength": 1,
          "type": "string"
        },
        "tool_call_id": {
          "minLength": 1,
          "type": "string"
        }
      },
      "required": [
        "tool_call_id",
        "name",
        "arguments"
      ],
      "type": "object"
    },
    "tokenUsage": {
      "additionalProperties": false,
      "properties": {
        "input_tokens": {
          "minimum": 0,
          "type": "integer"
        },
        "output_tokens": {
          "minimum": 0,
          "type": "integer"
        },
        "total_tokens": {
          "minimum": 0,
          "type": "integer"
        }
      },
      "type": "object"
    }
  },
  "oneOf": [
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "run_compiled"
            }
          },
          "required": [
            "plan_hash"
          ]
        },
        {
          "not": {
            "required": [
              "node_id"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "run_started"
            }
          },
          "required": [
            "plan_hash"
          ]
        },
        {
          "not": {
            "required": [
              "node_id"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "run_completed"
            }
          },
          "required": [
            "plan_hash",
            "outputs_artifact_key",
            "outputs_info"
          ]
        },
        {
          "not": {
            "required": [
              "node_id"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "properties": {
            "outputs_info": {
              "properties": {
                "included": {
                  "const": false
                }
              }
            }
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "run_failed"
            }
          },
          "required": [
            "plan_hash",
            "error"
          ]
        },
        {
          "not": {
            "required": [
              "node_id"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "run_canceled"
            }
          },
          "required": [
            "plan_hash",
            "error"
          ]
        },
        {
          "not": {
            "required": [
              "node_id"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_llm_call"
            }
          },
          "required": [
            "node_id",
            "llm_call"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_tool_call"
            }
          },
          "required": [
            "node_id",
            "tool_call"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_tool_result"
            }
          },
          "required": [
            "node_id",
            "tool_result"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_waiting"
            }
          },
          "required": [
            "node_id",
            "waiting"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_started"
            }
          },
          "required": [
            "node_id"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_succeeded"
            }
          },
          "required": [
            "node_id"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_failed"
            }
          },
          "required": [
            "node_id",
            "error"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_output_delta"
            }
          },
          "required": [
            "node_id",
            "delta"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "output_info"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        }
      ]
    },
    {
      "allOf": [
        {
          "properties": {
            "type": {
              "const": "node_output"
            }
          },
          "required": [
            "node_id",
            "artifact_key",
            "output_info"
          ]
        },
        {
          "not": {
            "required": [
              "plan_hash"
            ]
          }
        },
        {
          "not": {
            "required": [
              "llm_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_call"
            ]
          }
        },
        {
          "not": {
            "required": [
              "tool_result"
            ]
          }
        },
        {
          "not": {
            "required": [
              "waiting"
            ]
          }
        },
        {
          "not": {
            "required": [
              "delta"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_artifact_key"
            ]
          }
        },
        {
          "not": {
            "required": [
              "outputs_info"
            ]
          }
        },
        {
          "properties": {
            "output_info": {
              "properties": {
                "included": {
                  "const": false
                }
              }
            }
          }
        }
      ]
    }
  ],
  "properties": {
    "artifact_key": {
      "type": "string"
    },
    "delta": {
      "$ref": "#/definitions/nodeOutputDelta"
    },
    "envelope_version": {
      "const": "v0",
      "type": "string"
    },
    "error": {
      "$ref": "#/definitions/nodeError"
    },
    "llm_call": {
      "$ref": "#/definitions/nodeLLMCall"
    },
    "node_id": {
      "minLength": 1,
      "type": "string"
    },
    "output_info": {
      "$ref": "#/definitions/payloadInfo"
    },
    "outputs_artifact_key": {
      "type": "string"
    },
    "outputs_info": {
      "$ref": "#/definitions/payloadInfo"
    },
    "plan_hash": {
      "pattern": "^[0-9a-f]{64}$",
      "type": "string"
    },
    "run_id": {
      "format": "uuid",
      "type": "string"
    },
    "seq": {
      "minimum": 1,
      "type": "integer"
    },
    "tool_call": {
      "$ref": "#/definitions/nodeToolCall"
    },
    "tool_result": {
      "$ref": "#/definitions/nodeToolResult"
    },
    "ts": {
      "format": "date-time",
      "type": "string"
    },
    "type": {
      "enum": [
        "run_compiled",
        "run_started",
        "run_completed",
        "run_failed",
        "run_canceled",
        "node_llm_call",
        "node_tool_call",
        "node_tool_result",
        "node_waiting",
        "node_started",
        "node_succeeded",
        "node_failed",
        "node_output_delta",
        "node_output"
      ],
      "type": "string"
    },
    "waiting": {
      "$ref": "#/definitions/nodeWaiting"
    }
  },
  "required": [
    "envelope_version",
    "run_id",
    "seq",
    "ts",
    "type"
  ],
  "title": "ModelRelay run_event.v0",
  "type": "object"
}
